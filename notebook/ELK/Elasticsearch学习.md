# Elasticsearch学习

## ES 如何产生

### 大规模数据如何检索

[Elasticsearch学习](http://t.cn/RusMSlD)

当系统数据量上了10亿、100亿条的时候，我们在做系统架构的时候通常会从以下角度去考虑问题

- 用什么数据库? mysql、oracle、mongodb、hbase
- 如何解决单节点故障; lvs、F5、A10、zookeep、MQ
- 如何保证数据安全性; 热备、冷备、异地多活
- 如何解决检索难题; 数据库代理中间件 - mysql-proxy、Cobar、MaxScale
- 如何解决统计分析问题; 离线、近实时 

### 传统数据库的应对解决方案(关系型数据库)

解决要点：
- 通过主从备份解决数据安全性问题；
- 通过数据库代理中间件心跳监测，解决单节点故障问题；
- 通过代理中间件将查询语句分发到各个slave节点进行查询，并汇总结果

### 非关系型数据库的解决方案

解决要点：
- 通过副本备份保证数据安全性；
- 通过节点竞选机制解决单点问题；
- 先从配置库检索分片信息，然后将请求分发到各个节点，最后由路由节点合并并汇总结果

### 数据完全放入内存

## Elasticsearch

为解决以上问题，通常从以下方式寻找解决方法：
- 存储数据时按有序存储；
- 将数据和索引分离；
- 压缩数据；

Elasticsearch是开源高扩展的分布式全文检索引擎，可以近实时的存储、检索数据。扩展性好，可以扩展到上百台服务器，处理PB级别的数据。

Elasticsearch使用Java开发并使用Lucene做核心来实现所有索引和搜索功能，目的是通过简单的RESTful API来隐藏Lucene的复杂性

### Elasticsearh 解决问题

- 检索相关数据；
- 返回统计结果
- 速度块

### 工作原理

Elasticsearch 节点启动后，利用多播(multicast)(或者单播，如果更改了配置)寻找集群中的其它节点，并与之建立连接。

### 核心概念

- Cluster 集群
- Node 节点
- Shard 分片
    当有大量的文档时，由于内存的限制、磁盘处理能力不足、无法足够快的响应客户端请求时，一个节点可能不够。
    这种情况下，数据可以分为较小的分片。每个分片放在不同的服务器上。当你查询的索引分布在多个分片上时，ES会把查询发送给每个相关的分片，并将结果组合在一起，而应用程序并不知道分片的存在。即这个过程对用户来说是透明的
- Replia 副本
    为提高查询吞吐量或实现高可用性，可以使用分片副本。副本是一个分片的精确复制，每个分片可以有0或多个副本。
    ES中可以有许多相同的分片，其中之一被选择更改索引操作，这个特殊分片被称为主分片
    当主分片丢失时，集群将副本提升为新的主分片
- 全文检索
    全文检索检索对一篇文章进行索引，可以根据关键字搜索。
    全文索引检索把内容根据词的意义进行分词，然后分别创建索引

ELK = elasticsearch + logstash + kibana

### Elasticsearch特点和优势

- 分布式实时文件存储，可以将每一个字段存入索引，使其可以被检索到
- 实时分析的分布式搜索引擎
- 可扩展性强
- 支持插件，分词插件、同步插件、Hadoop插件、可视化插件等

## Elasticsearch 配置清单

### 节点配置
默认情况下，集群中的每个节点都可以处理Http请求和集群节点的数据传输

集群中的所有的节点都知道集群中其他所有的节点，可以将客户端请求转发到适当的节点

主节点(master):
node.master: true
node.data: false

数据节点(data):
node.master: false
node.data: true

客户端/路由节点(client):
node.master: false
node.data: false

> 默认情况下，节点同时是主节点和数据节点，这适合小集群（3个节点）；大于3个节点后，分离主节点和数据节点变得非常重要

### 线程池

尽量不要动线程池这个配置，如果要动，建议改为： 
int((核心数*3)/2)＋ 1
同时满足：不允许bulk和’indexing’线程池的大小大于CPU内核数

举例：24核处理器，检索服务器是24核，所以：线程池的大小=(24*3)/2+1=37
同时要满足cpu核数为24。37和24取最小值，应该选择24

默认的队列大小是1000

### 配置堆内存

Elasticsearch 默认安装后设置的堆内存是 1 GB

方式一：export ES_HEAP_SIZE=4g
方式二：./bin/elasticsearch -Xmx4g -Xms4g
方式三：5.x+建议使用
修改jvm.options配置文件
-Xms4g
-Xmx4g
> 确保堆内存最小值（ Xms ）与最大值（ Xmx ）的大小是相同的，防止程序在运行时改变堆内存大小， 这是一个很耗系统资源的过程

> 最大可分配堆内存大小为： 32GB与当前ES宿主机内存二者的最小值

ES宿主机内存：128GB，可供分配的堆内存：32GB。（建议31GB） 
ES宿主机内存：32GB，可供分配的堆内存：16GB。

### 禁止swapping操作

bootstrap.memory_lock: true

> 内存交换到磁盘对服务器性能来说是致命的

5.x以前叫做 bootstrap.mlockall

### 配置文件描述符数目

需要在ES启动用户下进行配置

- 设置环境变量
    vim /etc/profile 
    增加 ulimit -n 65535 用以设定同一时间打开的文件数的最大值为65535
    source /etc/profile 使得命令生效
- 修改limits.conf配置文件
    /etc/security/limits.conf
    增加
    * soft nofile 65536
    * hard nofile 65536
    用来限制打开文件数65535
- 使用ulimit -a 查看是否修改成功
- 
> Elasticsearch 在节点和 HTTP 客户端之间进行通信也使用了大量的套接字（注：sockets）。 所有这一切都需要足够的文件描述符

### 修改最大映射数量MMP

Elasticsearch 对各种文件混合使用了 NioFs(非阻塞文件系统)和MMapFs(内存映射文件系统)

确保你配置的最大映射数量，以便有足够的虚拟内存可用于 mmapped 文件

暂时设置
sysctl -w vm.max_map_count=262144

在 /etc/sysctl.conf 通过修改 vm.max_map_count 永久设置
confvm.max_map_count=262144

### 5.x之后更新配置

新增节点类型Ingest节点/提取节点

Ingest的用途
- Ingest节点和集群中的其他节点一样，但是它能够创建多个处理器管道，用以修改传入文档。类似 最常用的Logstash过滤器已被实现为处理器。
- Ingest节点 可用于执行常见的数据转换和丰富。 处理器配置为管道。 在写入时，Ingest Node有20个内置处理器，例如grok，date，gsub，小写/大写，删除和重命名等。
- 在批量请求或索引操作之前，Ingest节点拦截请求，并对文档进行处理

### 节点组合类型配置

一个节点的缺省配置是：主节点+数据节点两属性为一身。对于3-5个节点的小集群来讲，通常让所有节点存储数据和具有获得主节点的资格。你可以将任何请求发送给任何节点，并且由于所有节点都具有集群状态的副本，它们知道如何路由请求。

通常只有较大的集群才能开始分离专用主节点、数据节点。 对于许多用户场景，路由节点根本不一定是必需的。

专用协调节点（也称为client节点或路由节点）从数据节点中消除了聚合/查询的请求解析和最终阶段，并允许他们专注于处理数据。 在多大程度上这对集群有好处将因情况而异。 通常我会说，在查询大量使用情况下路由节点更常见。

## Elasticsearch 检索技巧